<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Solicitar Viaje</title>
    <script src="https://apis.google.com/js/api.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCUHs9GkMFd5CC9HkwZdQRe8okW6WqA8K0&libraries=places&callback=initMap" async defer></script>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #map { height: 400px; }
        #confirmarViaje { margin-top: 10px; }
        #tarifa { font-weight: bold; }
    </style>
</head>
<body>
    <h1>Solicitar Viaje</h1>
    <input id="origin" type="text" placeholder="Selecciona el origen">
    <input id="destination" type="text" placeholder="Selecciona el destino">
    <div id="map"></div>
    <button id="confirmarViaje">Confirmar Viaje</button>
    <p>Tarifa estimada: <span id="tarifa">-</span></p>
    <p id="estadoViaje"></p>

    <script>
        let map, originMarker, destinationMarker;
        let origin, destination;

        function initMap() {
            map = new google.maps.Map(document.getElementById("map"), {
                center: { lat: -34.6037, lng: -58.3816 },
                zoom: 12,
            });

            const autocompleteOrigin = new google.maps.places.Autocomplete(document.getElementById("origin"));
            const autocompleteDestination = new google.maps.places.Autocomplete(document.getElementById("destination"));

            autocompleteOrigin.addListener("place_changed", () => {
                const place = autocompleteOrigin.getPlace();
                origin = place.geometry.location;
                if (originMarker) originMarker.setMap(null);
                originMarker = new google.maps.Marker({
                    position: origin,
                    map: map,
                    title: "Origen",
                });
                calculateRoute();
            });

            autocompleteDestination.addListener("place_changed", () => {
                const place = autocompleteDestination.getPlace();
                destination = place.geometry.location;
                if (destinationMarker) destinationMarker.setMap(null);
                destinationMarker = new google.maps.Marker({
                    position: destination,
                    map: map,
                    title: "Destino",
                });
                calculateRoute();
            });
        }

        function calculateRoute() {
            if (!origin || !destination) return;

            const service = new google.maps.DistanceMatrixService();
            service.getDistanceMatrix(
                {
                    origins: [origin],
                    destinations: [destination],
                    travelMode: google.maps.TravelMode.DRIVING,
                },
                function (response, status) {
                    if (status === google.maps.DistanceMatrixStatus.OK) {
                        const distance = response.rows[0].elements[0].distance.value / 1000; // en kilÃ³metros
                        const tarifaMoto = distance * 500;
                        const tarifaAuto = distance * 1000;
                        document.getElementById("tarifa").innerText = `Moto: $${tarifaMoto.toFixed(2)} | Auto: $${tarifaAuto.toFixed(2)}`;
                    }
                }
            );
        }

        document.getElementById("confirmarViaje").addEventListener("click", () => {
            if (!origin || !destination) {
                alert("Selecciona origen y destino.");
                return;
            }

            document.getElementById("estadoViaje").innerText = "Buscando conductor...";
            assignDriver();
        });

        function assignDriver() {
            // Leer los datos de conductores desde Google Sheets
            gapi.client.sheets.spreadsheets.values.get({
                spreadsheetId: 'YOUR_SPREADSHEET_ID',
                range: 'Conductores!A:F',
            }).then((response) => {
                const conductores = response.result.values;
                let closestDriver = null;
                let closestDistance = Infinity;

                conductores.forEach((driver) => {
                    const driverLat = parseFloat(driver[2]);
                    const driverLng = parseFloat(driver[3]);
                    const driverLocation = new google.maps.LatLng(driverLat, driverLng);
                    const distance = google.maps.geometry.spherical.computeDistanceBetween(driverLocation, origin);

                    if (distance < closestDistance && driver[4] === "disponible") {
                        closestDistance = distance;
                        closestDriver = driver;
                    }
                });

                if (closestDriver) {
                    alert(`Conductor asignado: ${closestDriver[1]}`);
                    updateDriverState(closestDriver[0], "ocupado"); // Actualizar el estado del conductor a "ocupado"
                    document.getElementById("estadoViaje").innerText = `Conductor asignado: ${closestDriver[1]}`;
                    saveTripData(closestDriver[0]);
                } else {
                    alert('No hay conductores disponibles.');
                    document.getElementById("estadoViaje").innerText = "No hay conductores disponibles.";
                }
            });
        }

        function updateDriverState(driverId, newState) {
            const params = {
                spreadsheetId: 'YOUR_SPREADSHEET_ID',
                range: `Conductores!E${driverId}`, // Asumiendo que la columna E contiene el estado
                valueInputOption: 'RAW',
            };

            const valueRangeBody = {
                values: [[newState]],
            };

            gapi.client.sheets.spreadsheets.values.update(params, valueRangeBody)
                .then((response) => {
                    console.log('Estado actualizado:', response);
                });
        }

        function saveTripData(driverId) {
            const tripData = [
                [
                    Date.now(), // ID del viaje
                    origin.lat(),
                    origin.lng(),
                    destination.lat(),
                    destination.lng(),
                    "pendiente",
                    driverId,
                ],
            ];

            const params = {
                spreadsheetId: 'YOUR_SPREADSHEET_ID',
                range: 'Viajes!A:G',
                valueInputOption: 'RAW',
            };

            const valueRangeBody = {
                values: tripData,
            };

            gapi.client.sheets.spreadsheets.values.append(params, valueRangeBody)
                .then((response) => {
                    console.log("Viaje agregado: ", response);
                })
                .catch((error) => {
                    console.error("Error al agregar viaje: ", error);
                });
        }

        // Inicializar Google Sheets API
        function start() {
            gapi.client.init({
                apiKey: 'YOUR_GOOGLE_API_KEY',
                clientId: 'YOUR_GOOGLE_CLIENT_ID',
                scope: 'https://www.googleapis.com/auth/spreadsheets',
                discoveryDocs: ['https://sheets.googleapis.com/$discovery/rest?version=v4'],
            }).then(function () {
                console.log("Google Sheets API inicializada.");
            });
        }

        gapi.load('client:auth2', start);
    </script>
</body>
</html>
